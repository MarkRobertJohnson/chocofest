##AH:UseTextMode
module EnsureChocolateyPackages<%ChocolateyPackages>
{
    set %ChocolateyPackages = %FromJson($ChocolateyPackagesBuildJson);

    # Loop over Module list to install
    foreach $packageName in @MapKeys(%ChocolateyPackages)
    {

        set $packageVersion = %ChocolateyPackages[$packageName];

        Log-Information Ensuring Chocolatey package $packageName $packageVersion;
        
        set $startTime = $PSEval("Get-Date");

        PSDsc cChoco::cchocopackageinstaller
        (
            Otter_ConfigurationKey: Name,
            Name: $PackageName,
            Version: $PackageVersion,
            Ensure: Present,
            AutoUpgrade: True
        );

        call LogElapsedTime
        (
            FromDateTime: $startTime
        );

    }
}
