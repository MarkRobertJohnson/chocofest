##AH:UseTextMode
module EnsureChocolateyPackages<%ChocolateyPackages>
{
    set %ChocolateyPackages = %FromJson($ChocolateyPackagesBuildJson);

    # Loop over Module list to install
    foreach $packageName in @MapKeys(%ChocolateyPackages)
    {
        with retry = 5, async
        {
            set $packageVersion = %ChocolateyPackages[$packageName];

            Log-Information Ensuring Chocolatey package $packageName $packageVersion;

            set $startTime = $PSEval("Get-Date");

            # PSDsc cChoco::cchocopackageinstaller
            # (
            # Otter_ConfigurationKey: Name,
            # Name: $PackageName,
            # Version: $PackageVersion,
            # Ensure: Present,
            # AutoUpgrade: True
            # );
            # Chocolatey::Ensure-Package
            # (
            # Name: $PackageName,
            # Version: $PackageVersion,
            # Source: $ChocolateyFeedUrl
            # );
            PSEnsure
            (
                Key: Chocolatey package: $PackageName|$PackageVersion,
                Value: $PackageName|$PackageVersion,
                Collect: 'c:\ProgramData\Chocolatey\choco.exe list --limit-output --by-id-only --version=$PackageVersion --exact "$PackagName"; if(`$LASTEXITCODE) {throw "Error installing $PackageName|$PackageVersion"}',
                Configure: c:\ProgramData\Chocolatey\choco.exe upgrade $Packagename --version=$PackageVersion -y -s $ChocolateyFeedUrl --no-progress,
                UseExitCode: false
            );

            call LogElapsedTime
            (
                FromDateTime: $startTime
            );
        }
    }
}
